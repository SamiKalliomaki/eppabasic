<!DOCTYPE html>
<html>
<head>
    <title>Eppabasic</title>
    <style>
        #code {
            width: 100%;
            height: 30em;
        }

        .hidden > * > * {
            display: none;
        }

        #errBox {
            color: #f00;
        }

        #tree, #compiled {
            width: 50%;
            float: left;
        }

        #compiled {
            font-family: monospace;
        }
    </style>
    <script src="nodes.js"></script>
    <script src="lexer.js"></script>
    <script src="parser.js"></script>
    <script src="typechecker.js"></script>
    <script src="atomicchecker.js"></script>
    <script src="compiler.js"></script>
    <script>
        //(function () {
        //    var MB = 1024 * 1024;
        //    var SIZE = 256 * MB;
        //    var STACK_SIZE = 2 * MB;
        //    var HEAP_SIZE = SIZE - STACK_SIZE;
        //    var buffer = new ArrayBuffer(SIZE);

        //    var asm = (function (stdlib, env, heap) {
        //        "use asm";

        //        var log = env.log;

        //        function recursion() {
        //            var a = 0;
        //            if (1) {
        //            }
        //        }

        //        return {
        //            f: recursion
        //        };
        //    })(
        //    window,
        //    {
        //        log: console.log
        //    }
        //    );

        //    //asm.f(3, 3);
        //    console.log(asm.f(2, 2));
        //})();

        function astToHtml(ast) {
            if (typeof ast === 'string'
                || typeof ast === 'number'
                || typeof ast === 'boolean')
                return ast;
            if (!ast)
                return '';
            var res = '';
            for (key in ast) {
                if (ast.hasOwnProperty(key)
                    && typeof ast[key] !== 'function') {
                    res += '<li><strong>' + key + '</strong>: ' + astToHtml(ast[key]) + '</li>';
                }
            }
            return (ast.nodeType ? ast.nodeType : '') + (res ? ('<ul>' + res + '</ul>') : '');
        }

        function hideTree(node) {
            if (node.tagName === 'LI') {
                node.classList.add('hidden');
                node.addEventListener('dblclick', function (e) {
                    e.stopPropagation();
                    e.preventDefault();

                    if (node.classList.contains('hidden'))
                        node.classList.remove('hidden');
                    else
                        node.classList.add('hidden');

                    return false;
                }, false);
            }

            for (var i = 0; i < node.children.length; i++) {
                hideTree(node.children[i]);
            }
        }

        function beautifyJs(code) {
            return code; //code.replace(/\n/g, '<br>');
        }

        function compile() {
            var src = document.getElementById('code').value;

            try {
                // No errors, yer
                document.getElementById('errBox').innerHTML = '';


                var parser = new Parser(src);
                var ast = parser.parse();

                // Show incomplete ast as html
                document.getElementById('tree').innerHTML = astToHtml(ast);

                var compiler = new Compiler(ast);

                // Define 'native' functions
                //compiler.defineJsFunction('LINE', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], '_drawLine');
                //compiler.defineJsFunction('RECT', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], '_dradRect');
                //compiler.defineJsFunction('ELLIPSE', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], '_drawEllipse');
                //compiler.defineJsFunction('log', ['INTEGER'], 'log');
                //compiler.defineJsFunction('DRAWSCREEN', [], '_drawScreen', undefined, true);
                compiler.defineJsFunction('LINE', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], 'line');
                compiler.defineJsFunction('LOG', ['INTEGER'], 'log');

                var compiled = compiler.compile();

                document.getElementById('compiled').innerHTML = beautifyJs(compiled);

                // Show ast as html
                document.getElementById('tree').innerHTML = astToHtml(ast);
                hideTree(document.getElementById('tree').children[0]);
            } catch (e) {
                document.getElementById('errBox').innerHTML = e.message;
                throw e;
            }
        }
    </script>
</head>
<body>
    <textarea id="code">
' Just a short example code for testing purposes
' with a multiline comment at the start of the file

' Define some variables needed
DIM a AS INTEGER = 10
DIM b = 20
DIM c = a + b

FOR i = 0 TO (10*2)
  DIM d = a - b
  IF a = b THEN             ' A comment at the end of a line?
    DIM e = a * a
    LINE a, b, 10, 10       ' A commented comment?
  ELSEIF b = c THEN
    RECT b, c, 20, 10
  ELSE
    ELLIPSE a, c, 10, 10
  ENDIF
NEXT i

' Define earlier used function in the end
FUNCTION ADD(a AS INTEGER, b AS INTEGER) AS INTEGER
RETURN a + b
END FUNCTION
    </textarea>
    <div id="errBox"></div>
    <button onclick="compile()">Compile</button>

    <div>
        <div id="tree"></div>
        <pre id="compiled"></pre>
    </div>
</body>
</html>
