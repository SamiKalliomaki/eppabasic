<!DOCTYPE html>
<html>
<head>
    <title>Eppabasic</title>
    <style>
        #code {
            width: 100%;
            height: 30em;
        }

        .hidden > * > * {
            display: none;
        }

        #errBox {
            color: #f00;
        }

        #tree, #compiled {
            width: 50%;
            float: left;
        }

        #compiled {
            font-family: monospace;
        }
    </style>
    <script src="polyfill.js"></script>
    <script src="nodes.js"></script>
    <script src="lexer.js"></script>
    <script src="parser.js"></script>
    <script src="typechecker.js"></script>
    <script src="atomicchecker.js"></script>
    <script src="compiler.js"></script>
    <script>
        //(function () {
        //    var MB = 1024 * 1024;
        //    var SIZE = 256 * MB;
        //    var STACK_SIZE = 2 * MB;
        //    var HEAP_SIZE = SIZE - STACK_SIZE;
        //    var buffer = new ArrayBuffer(SIZE);

        //    var asm = (function (stdlib, env, heap) {
        //        "use asm";

        //        var log = env.log;

        //        function recursion() {
        //            var a = 0;
        //            if (1) {
        //            }
        //        }

        //        return {
        //            f: recursion
        //        };
        //    })(
        //    window,
        //    {
        //        log: console.log
        //    }
        //    );

        //    //asm.f(3, 3);
        //    console.log(asm.f(2, 2));
        //})();

        function astToHtml(ast) {
            if (typeof ast === 'string'
                || typeof ast === 'number'
                || typeof ast === 'boolean')
                return ast;
            if (!ast)
                return '';
            var res = '';
            for (key in ast) {
                if (ast.hasOwnProperty(key)
                    && typeof ast[key] !== 'function') {
                    res += '<li><strong>' + key + '</strong>: ' + astToHtml(ast[key]) + '</li>';
                }
            }
            return (ast.nodeType ? ast.nodeType : '') + (res ? ('<ul>' + res + '</ul>') : '');
        }

        function hideTree(node) {
            if (node.tagName === 'LI') {
                node.classList.add('hidden');
                node.addEventListener('dblclick', function (e) {
                    e.stopPropagation();
                    e.preventDefault();

                    if (node.classList.contains('hidden'))
                        node.classList.remove('hidden');
                    else
                        node.classList.add('hidden');

                    return false;
                }, false);
            }

            for (var i = 0; i < node.children.length; i++) {
                hideTree(node.children[i]);
            }
        }

        function beautifyJs(code) {
            return code; //code.replace(/\n/g, '<br>');
        }

        var debugWindow;
        function compile() {
            var src = document.getElementById('code').value;

            try {
                // No errors, yet
                document.getElementById('errBox').innerHTML = '';


                var parser = new Parser(src);
                var ast = parser.parse();

                // Show incomplete ast as html
                document.getElementById('tree').innerHTML = astToHtml(ast);

                var compiler = new Compiler(ast);

                // Drawing functions
                compiler.defineJsFunction('CLEARCOLOR', ['INTEGER', 'INTEGER', 'INTEGER'], 'clearColor');
                compiler.defineJsFunction('LINECOLOR', ['INTEGER', 'INTEGER', 'INTEGER'], 'lineColor');
                compiler.defineJsFunction('FILLCOLOR', ['INTEGER', 'INTEGER', 'INTEGER'], 'fillColor');
                compiler.defineJsFunction('LINE', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], 'line');
                compiler.defineJsFunction('CIRCLE', ['INTEGER', 'INTEGER', 'INTEGER'], 'circle');
                compiler.defineJsFunction('FILLCIRCLE', ['INTEGER', 'INTEGER', 'INTEGER'], 'fillCircle');
                compiler.defineJsFunction('RECT', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], 'rect');
                compiler.defineJsFunction('FILLRECT', ['INTEGER', 'INTEGER', 'INTEGER', 'INTEGER'], 'fillRect');
                compiler.defineJsFunction('DOT', ['INTEGER', 'INTEGER'], 'dot');
                compiler.defineJsFunction('CLEAR', [], 'clear');
                compiler.defineJsFunction('DRAWSCREEN', [], 'drawScreen', undefined, false);

                // Mathematical functions
                compiler.defineJsFunction('DBL', ['INTEGER'], 'dbl', 'DOUBLE');
                compiler.defineJsFunction('INT', ['DOUBLE'], 'int', 'INTEGER');
                compiler.defineJsFunction('SIN', ['INTEGER'], 'sinInt', 'DOUBLE');
                compiler.defineJsFunction('SIN', ['DOUBLE'], 'sinDbl', 'DOUBLE');
                compiler.defineJsFunction('COS', ['INTEGER'], 'cosInt', 'DOUBLE');
                compiler.defineJsFunction('COS', ['DOUBLE'], 'cosDbl', 'DOUBLE');

                // Time functions
                compiler.defineJsFunction('HOURS', [], 'hours', 'INTEGER');
                compiler.defineJsFunction('MINUTES', [], 'minutes', 'INTEGER');
                compiler.defineJsFunction('SECONDS', [], 'seconds', 'INTEGER');
                compiler.defineJsFunction('MILLISECONDS', [], 'milliseconds', 'INTEGER');

                // Logging functions
                compiler.defineJsFunction('LOG', ['INTEGER'], 'logInt');
                compiler.defineJsFunction('LOG', ['DOUBLE'], 'logDbl');

                var compiled = compiler.compile();

                document.getElementById('compiled').innerHTML = beautifyJs(compiled);

                // Show ast as html
                document.getElementById('tree').innerHTML = astToHtml(ast);
                hideTree(document.getElementById('tree').children[0]);

                if (debugWindow)
                    debugWindow.close()
                debugWindow = window.open('test.html', '', 'dependent,dialog', true);
                console.log(debugWindow);
                function onLoad() {
                    if (debugWindow.document.getElementById('programCode')) {
                        // Loaded
                        debugWindow.document.getElementById('programCode').innerHTML = compiled;
                        debugWindow.init();
                        debugWindow.ebstart();
                    } else {
                        setTimeout(onLoad, 10);
                    }
                }
                onLoad();
                /*debugWindow.addEventListener('load', function insertCode() {
                    
                });*/
            } catch (e) {
                document.getElementById('errBox').innerHTML = e.message;
                throw e;
            }
        }
    </script>
</head>
<body>
    <textarea id="code">
' Define some settings
DIM midX = 640/2
DIM midY = 480/2
DIM r = 200
DIM hourR = INT(r*0.5)
DIM minR = INT(r*0.7)
DIM secR = INT(r*0.9)
DIM pi = 3.141592653589793
DIM dotR = r - 20

CLEARCOLOR 0, 0, 0

' Main loop
REPEAT
  DIM angle AS DOUBLE
  CLEAR

  ' Draw the background
  LINECOLOR 255, 255, 255
  CIRCLE midX, midY, r

  FOR i = 1 TO 12
    angle = 2*pi*i/12
    LINE midX + INT(SIN(angle)*dotR), midY - INT(COS(angle)*dotR), midX + INT(SIN(angle)*r), midY - INT(COS(angle)*r)
  NEXT i
  
  ' To make seconds go smoothier
  angle = 2*pi*MILLISECONDS()/1000

  ' Draw the second hand
  angle = (2*pi*SECONDS() + angle)/60
  LINECOLOR 255, 0, 0
  LINE midX, midY, midX + INT(SIN(angle)*secR), midY - INT(COS(angle)*secR)

  ' Draw the minute hand
  angle = (2*pi*MINUTES() + angle)/60
  LINECOLOR 0, 255, 0
  LINE midX, midY, midX + INT(SIN(angle)*minR), midY - INT(COS(angle)*minR)

  ' Draw the hour hand
  angle = (2*pi*HOURS() + angle)/12
  LINECOLOR 0, 0, 255
  LINE midX, midY, midX + INT(SIN(angle)*hourR), midY - INT(COS(angle)*hourR)


  ' Show everything on screen
  DRAWSCREEN
FOREVER
    </textarea>
    <div id="errBox"></div>
    <button onclick="compile()">Compile</button>

    <div>
        <div id="tree"></div>
        <pre id="compiled"></pre>
    </div>
</body>
</html>
