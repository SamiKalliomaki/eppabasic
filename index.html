<!DOCTYPE html>
<html>
<head>
    <title>Eppabasic</title>
    <style>
        #code {
            width: 100%;
            height: 30em;
        }

        .hidden > * > * {
            display: none;
        }

        #errBox {
            color: #f00;
        }

        #tree, #compiled {
            width: 50%;
            float: left;
        }

        #compiled {
            font-family: monospace;
        }
    </style>
    <script src="compiler/polyfill.js"></script>
    <script src="compiler/nodes.js"></script>
    <script src="compiler/types.js"></script>
    <script src="compiler/lexer.js"></script>
    <script src="compiler/parser.js"></script>
    <script src="compiler/typechecker.js"></script>
    <script src="compiler/atomicchecker.js"></script>
    <script src="compiler/compiler.js"></script>
    <script>
        function astToHtml(ast) {
            if (ast === Types.Integer)
                return 'Integer';
            if (ast === Types.Double)
                return 'Double';
            if (typeof ast === 'string'
                || typeof ast === 'number'
                || typeof ast === 'boolean')
                return ast;
            if (!ast)
                return '';
            var res = '';
            for (key in ast) {
                if (ast.hasOwnProperty(key)
                    && typeof ast[key] !== 'function') {
                    res += '<li><strong>' + key + '</strong>: ' + astToHtml(ast[key]) + '</li>';
                }
            }
            return (ast.nodeType ? ast.nodeType : '') + (res ? ('<ul>' + res + '</ul>') : '');
        }

        function hideTree(node) {
            if (node.tagName === 'LI') {
                node.classList.add('hidden');
                node.addEventListener('dblclick', function (e) {
                    e.stopPropagation();
                    e.preventDefault();

                    if (node.classList.contains('hidden'))
                        node.classList.remove('hidden');
                    else
                        node.classList.add('hidden');

                    return false;
                }, false);
            }

            for (var i = 0; i < node.children.length; i++) {
                hideTree(node.children[i]);
            }
        }

        function beautifyJs(code) {
            return code; //code.replace(/\n/g, '<br>');
        }

        var debugWindow;
        function compile() {
            var src = document.getElementById('code').value;

            try {
                // No errors, yet
                document.getElementById('errBox').innerHTML = '';


                var parser = new Parser(src);
                var ast = parser.parse();

                // Show incomplete ast as html
                document.getElementById('tree').innerHTML = astToHtml(ast);

                var compiler = new Compiler(ast);

                // Drawing functions
                compiler.defineJsFunction('CLEARCOLOR', [Types.Integer, Types.Integer, Types.Integer], 'clearColor');
                compiler.defineJsFunction('LINECOLOR', [Types.Integer, Types.Integer, Types.Integer], 'lineColor');
                compiler.defineJsFunction('FILLCOLOR', [Types.Integer, Types.Integer, Types.Integer], 'fillColor');
                compiler.defineJsFunction('LINE', [Types.Integer, Types.Integer, Types.Integer, Types.Integer], 'line');
                compiler.defineJsFunction('CIRCLE', [Types.Integer, Types.Integer, Types.Integer], 'circle');
                compiler.defineJsFunction('FILLCIRCLE', [Types.Integer, Types.Integer, Types.Integer], 'fillCircle');
                compiler.defineJsFunction('RECT', [Types.Integer, Types.Integer, Types.Integer, Types.Integer], 'rect');
                compiler.defineJsFunction('FILLRECT', [Types.Integer, Types.Integer, Types.Integer, Types.Integer], 'fillRect');
                compiler.defineJsFunction('DOT', [Types.Integer, Types.Integer], 'dot');
                compiler.defineJsFunction('CLEAR', [], 'clear');
                compiler.defineJsFunction('DRAWSCREEN', [], 'drawScreen', undefined, false);
                compiler.defineJsFunction('PRINT', [Types.Integer], 'printInt');
                compiler.defineJsFunction('PRINT', [Types.Double], 'printDbl');

                // Mathematical functions
                compiler.defineJsFunction('DBL', [Types.Integer], 'dbl', Types.Double);
                compiler.defineJsFunction('INT', [Types.Double], 'int', Types.Integer);
                compiler.defineJsFunction('SIN', [Types.Integer], 'sinInt', Types.Double);
                compiler.defineJsFunction('SIN', [Types.Double], 'sinDbl', Types.Double);
                compiler.defineJsFunction('COS', [Types.Integer], 'cosInt', Types.Double);
                compiler.defineJsFunction('COS', [Types.Double], 'cosDbl', Types.Double);

                compiler.defineJsFunction('SQR', [Types.Integer], 'sqrInt', Types.Double);
                compiler.defineJsFunction('SQR', [Types.Double], 'sqrDbl', Types.Double);

                // Time functions
                compiler.defineJsFunction('HOURS', [], 'hours', Types.Integer);
                compiler.defineJsFunction('MINUTES', [], 'minutes', Types.Integer);
                compiler.defineJsFunction('SECONDS', [], 'seconds', Types.Integer);
                compiler.defineJsFunction('MILLISECONDS', [], 'milliseconds', Types.Integer);

                // Logging functions
                compiler.defineJsFunction('LOG', [Types.Integer], 'logInt');
                compiler.defineJsFunction('LOG', [Types.Double], 'logDbl');

                var compiled = compiler.compile();

                document.getElementById('compiled').innerHTML = beautifyJs(compiled);

                // Show ast as html
                document.getElementById('tree').innerHTML = astToHtml(ast);
                hideTree(document.getElementById('tree').children[0]);

                if (debugWindow)
                    debugWindow.close()
                debugWindow = window.open('test.html', '', 'dependent,dialog,height=520,width=640', true);
                console.log(debugWindow);
                function onLoad() {
                    if (debugWindow.document.getElementById('programCode')) {
                        // Loaded
                        debugWindow.document.getElementById('programCode').innerHTML = compiled;
                        debugWindow.init();
                        debugWindow.ebstart();
                    } else {
                        setTimeout(onLoad, 10);
                    }
                }
                onLoad();
                /*debugWindow.addEventListener('load', function insertCode() {

                });*/
            } catch (e) {
                document.getElementById('errBox').innerHTML = e.message;
                throw e;
            }
        }
    </script>
</head>
<body>
    <textarea id="code">
        ' Define some settings
DIM midX = 640/2
DIM midY = 480/2
DIM r = 200
DIM hourR = INT(r*0.5)
DIM minR = INT(r*0.7)
DIM secR = INT(r*0.9)
DIM pi = 3.141592653589793
DIM dotR = r - 20

CLEARCOLOR 0, 0, 0

' Main loop
REPEAT
  DIM angle AS DOUBLE
  CLEAR

  ' Draw the background
  LINECOLOR 255, 255, 255
  CIRCLE midX, midY, r

  FOR i = 1 TO 12
    angle = 2*pi*i/12
    LINE midX + INT(SIN(angle)*dotR), midY - INT(COS(angle)*dotR), midX + INT(SIN(angle)*r), midY - INT(COS(angle)*r)
  NEXT i
  
  ' To make seconds go smoothier
  angle = 2*pi*MILLISECONDS()/1000

  ' Draw the second hand
  angle = (2*pi*SECONDS() + angle)/60
  LINECOLOR 255, 0, 0
  LINE midX, midY, midX + INT(SIN(angle)*secR), midY - INT(COS(angle)*secR)

  ' Draw the minute hand
  angle = (2*pi*MINUTES() + angle)/60
  LINECOLOR 0, 255, 0
  LINE midX, midY, midX + INT(SIN(angle)*minR), midY - INT(COS(angle)*minR)

  ' Draw the hour hand
  angle = (2*pi*HOURS() + angle)/12
  LINECOLOR 0, 0, 255
  LINE midX, midY, midX + INT(SIN(angle)*hourR), midY - INT(COS(angle)*hourR)


  ' Show everything on screen
  DRAWSCREEN
FOREVER

    </textarea>
    <div id="errBox"></div>
    <button onclick="compile()">Compile</button>

    <div>
        <div id="tree"></div>
        <pre id="compiled"></pre>
    </div>
</body>
</html>
