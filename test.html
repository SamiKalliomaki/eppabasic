<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style>
        #canv {
            width: 100%;
            border: 1px dashed #000;
        }
    </style>
    <script>
        if (!window.Math.imul) {
            window.Math.imul = function (a, b) {
                return a * b;           // TODO Fix
            }
        }
        function Program(stdlib, env, heap) {
            "use asm";
            var MEMS32 = new stdlib.Int32Array(heap);
            var MEMU32 = new stdlib.Uint32Array(heap);
            var MEMF32 = new stdlib.Float32Array(heap);
            var MEMF64 = new stdlib.Float64Array(heap);
            var imul = stdlib.Math.imul;
            var __log = env.__log;
            var SP = 0;
            var CS = 0;
            var line = env.line;
            var drawScreen = env.drawScreen;
            var log = env.log;
            var dbl = env.dbl;
            var int = env.int;
            var sinInt = env.sinInt;
            var sinDbl = env.sinDbl;
            var cosInt = env.cosInt;
            var cosDbl = env.cosDbl;
            function next() {
                while ($fTable[MEMU32[CS >> 2] & 15]() | 0);
            }
            function init() {
                SP = 0;
                CS = 1024;
                MEMU32[CS >> 2] = 9;
            }
            function sp() {
                return SP | 0;
            }
            function cs() {
                return CS | 0;
            }
            // LINE
            function $f0() {
                __log(0);
                line(SP | 0);
                SP = (SP - 16) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // DRAWSCREEN
            function $f1() {
                __log(1);
                drawScreen(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 0;
            }
            // LOG
            function $f2() {
                __log(2);
                log(SP | 0);
                SP = (SP - 4) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // DBL
            function $f3() {
                __log(3);
                dbl(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // INT
            function $f4() {
                __log(4);
                int(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // SIN
            function $f5() {
                __log(5);
                sinInt(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // SIN
            function $f6() {
                __log(6);
                sinDbl(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // COS
            function $f7() {
                __log(7);
                cosInt(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // COS
            function $f8() {
                __log(8);
                cosDbl(SP | 0);
                SP = (SP - 0) | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // MAIN
            function $f9() {
                __log(9);
                SP = (SP + 8) | 0;
                MEMS32[SP >> 2] = ((10) | 0); SP = (SP + 4) | 0;
                MEMS32[((SP - 12) | 0) >> 2] = MEMS32[((SP - 4) | 0) >> 2];
                SP = (SP - 4) | 0;
                MEMS32[SP >> 2] = ((17) | 0); SP = (SP + 4) | 0;
                MEMS32[((SP - 8) | 0) >> 2] = MEMS32[((SP - 4) | 0) >> 2];
                SP = (SP - 4) | 0;
                MEMS32[SP >> 2] = ((0) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((0) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                CS = (CS + 4) | 0;
                MEMU32[CS >> 2] = 0;
                $f0() | 0;
                MEMS32[SP >> 2] = ((((MEMS32[((SP - 8) | 0) >> 2]) | 0)) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((((MEMS32[((SP - 8) | 0) >> 2]) | 0)) | 0); SP = (SP + 4) | 0;
                MEMS32[((SP - 8) | 0) >> 2] = ((((MEMS32[((SP - 8) | 0) >> 2]) | 0) < ((MEMS32[((SP - 4) | 0) >> 2]) | 0)) | 0);
                SP = (SP - 8 + 4) | 0;
                MEMU32[CS >> 2] = 10;
                if (((MEMS32[((SP - 4) | 0) >> 2]) | 0)) {
                    SP = (SP - 4) | 0;
                    CS = (CS + 4) | 0;
                    MEMU32[CS >> 2] = 11;
                } else {
                    SP = (SP - 4) | 0;
                    CS = (CS + 4) | 0;
                    MEMU32[CS >> 2] = 12;
                }
                return 1;
            }
            // MAIN
            function $f10() {
                __log(10);
                MEMS32[SP >> 2] = ((200) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((200) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((300) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((300) | 0); SP = (SP + 4) | 0;
                CS = (CS + 4) | 0;
                MEMU32[CS >> 2] = 0;
                $f0() | 0;
                SP = (SP - 8) | 0;
                MEMU32[CS >> 2] = 13;
                return 1;
            }
            // MAIN
            function $f11() {
                __log(11);
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((200) | 0); SP = (SP + 4) | 0;
                CS = (CS + 4) | 0;
                MEMU32[CS >> 2] = 0;
                $f0() | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // MAIN
            function $f12() {
                __log(12);
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((200) | 0); SP = (SP + 4) | 0;
                MEMS32[SP >> 2] = ((100) | 0); SP = (SP + 4) | 0;
                CS = (CS + 4) | 0;
                MEMU32[CS >> 2] = 0;
                $f0() | 0;
                CS = (CS - 4) | 0;
                return 1;
            }
            // END
            function $f13() {
                __log(13);

                return 0;
            }
            var $fTable = [$f0, $f1, $f2, $f3, $f4, $f5, $f6, $f7, $f8, $f9, $f10, $f11, $f12, $f13, $f0, $f0];
            return {
                init: init,

                eset: init,
                next: next,
                sp: sp,
                cs: cs
            };
        }

        function onload() {
            var heap = new ArrayBuffer(1024 * 1024);
            var canvas = document.getElementById('canv');
            var ctx = canvas.getContext('2d');
            var MEMS32 = new Int32Array(heap);
            var MEMF32 = new Float32Array(heap);
            var game = Program(
                window,
                {
                    line: function line(sp) {
                        var x1 = MEMS32[(sp - 16) >> 2];
                        var y1 = MEMS32[(sp - 12) >> 2];
                        var x2 = MEMS32[(sp - 8) >> 2];
                        var y2 = MEMS32[(sp - 4) >> 2];

                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    },
                    drawScreen: function drawScreen(sp) {

                    },
                    log: function log(sp) {
                        var x = MEMS32[(sp - 4) >> 2];
                        console.log(x);
                    },
                    dbl: function dbl(sp) {
                        var x = MEMS32[(sp - 4) >> 2];
                        MEMF32[(sp - 4) >> 2] = x;
                    },
                    int: function int(sp) {
                        var x = MEMF32[(sp - 4) >> 2];
                        MEMS32[(sp - 4) >> 2] = x;
                    },
                    sinInt: function sinInt(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.sin(MEMS32[(sp - 4) >> 2]);
                    },
                    sinDbl: function sinDbl(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.sin(MEMF32[(sp - 4) >> 2]);
                    },
                    cosInt: function cosInt(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.cos(MEMS32[(sp - 4) >> 2]);
                    },
                    cosDbl: function cosDbl(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.cos(MEMF32[(sp - 4) >> 2]);
                    },
                    __log: function __log(i) {
                        return;
                        console.log(i);
                        var sp = game.sp() >> 2;
                        var cs = game.cs() >> 2;

                        // Dump memory
                        var dmp = [];
                        var buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(i);
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(MEMS32[i]);
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(i === sp ? '^' : '');
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(MEMS32[256 + i]);
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(i === (cs - 256) ? '^' : '');
                        dmp.push(buf.join('\t'));


                        document.getElementById('memdump').innerHTML = dmp.join('\n');
                    }
                },
                heap);

            game.init();
            var running = false;
            function step() {
                game.next();
                if (running)
                    window.requestAnimationFrame(step);
            }
            function reset() {
                canvas.width = canvas.width;        // Clear the canvas
                stop();
                game.reset();
            }
            function start() {
                running = true;
                step();
            }
            function stop() {
                running = false;
            }
            document.getElementById('startBtn').addEventListener('click', start);
            document.getElementById('stopBtn').addEventListener('click', stop);
            document.getElementById('resetBtn').addEventListener('click', reset);
            document.getElementById('stepBtn').addEventListener('click', step);
        }
    </script>
</head>
<body onload="onload()">
    <div id="header">
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="resetBtn">Reset</button>
        <button id="stepBtn">Step</button>
        <pre id="memdump"></pre>
    </div>
    <canvas id="canv" width="640" height="480"></canvas>
</body>
</html>
