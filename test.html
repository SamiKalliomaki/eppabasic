<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style>
        #canv {
            width: 100%;
            border: 1px dashed #000;
        }
    </style>
    <script id="programCode"></script>
    <script>
        // A polyfill
        if (!window.Math.imul) {
            window.Math.imul = function (a, b) {
                return a * b;           // TODO Fix
            }
        }

        function init() {
            var heap = new ArrayBuffer(1024 * 1024);
            var canvas = document.getElementById('canv');
            var ctx = canvas.getContext('2d');
            var MEMS32 = new Int32Array(heap);
            var MEMF32 = new Float32Array(heap);

            var frameCount = 0;
            var lastFrame = new Date().getTime();
            var fps = 0;
            var fpsBox = document.getElementById('fpsBox');

            var game = Program(
                window,
                {
                    // Draw functions
                    clearColor: function lineColor(sp) {
                        var r = MEMS32[(sp - 12) >> 2];
                        var g = MEMS32[(sp - 8) >> 2];
                        var b = MEMS32[(sp - 4) >> 2];
                        game.clearColor = 'rgb(' + r + ',' + g + ',' + b + ')';
                    },
                    lineColor: function lineColor(sp) {
                        var r = MEMS32[(sp - 12) >> 2];
                        var g = MEMS32[(sp - 8) >> 2];
                        var b = MEMS32[(sp - 4) >> 2];
                        ctx.strokeStyle = 'rgb(' + r + ',' + g + ',' + b + ')';
                    },
                    fillColor: function fillColor(sp) {
                        var r = MEMS32[(sp - 12) >> 2];
                        var g = MEMS32[(sp - 8) >> 2];
                        var b = MEMS32[(sp - 4) >> 2];
                        ctx.fillStyle = 'rgb(' + r + ',' + g + ',' + b + ')';
                    },
                    rect: function rect(sp) {
                        var x = MEMS32[(sp - 16) >> 2];
                        var y = MEMS32[(sp - 12) >> 2];
                        var w = MEMS32[(sp - 8) >> 2];
                        var h = MEMS32[(sp - 4) >> 2];

                        ctx.rect(x, y, w, h);
                    },
                    fillRect: function fillRect(sp) {
                        var x = MEMS32[(sp - 16) >> 2];
                        var y = MEMS32[(sp - 12) >> 2];
                        var w = MEMS32[(sp - 8) >> 2];
                        var h = MEMS32[(sp - 4) >> 2];

                        ctx.fillRect(x, y, w, h);
                    },
                    circle: function circle(sp) {
                        var x = MEMS32[(sp - 12) >> 2];
                        var y = MEMS32[(sp - 8) >> 2];
                        var r = MEMS32[(sp - 4) >> 2];

                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                        ctx.stroke();
                    },
                    fillCircle: function fillCircle(sp) {
                        var x = MEMS32[(sp - 12) >> 2];
                        var y = MEMS32[(sp - 8) >> 2];
                        var r = MEMS32[(sp - 4) >> 2];

                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                        ctx.fill();
                    },
                    line: function line(sp) {
                        var x1 = MEMS32[(sp - 16) >> 2];
                        var y1 = MEMS32[(sp - 12) >> 2];
                        var x2 = MEMS32[(sp - 8) >> 2];
                        var y2 = MEMS32[(sp - 4) >> 2];

                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    },
                    dot: function dot(sp) {
                        var x = MEMS32[(sp - 8) >> 2];
                        var y = MEMS32[(sp - 4) >> 2];
                        ctx.fillRect(x, y, 1, 1);
                    },
                    clear: function clear(sp) {
                        var origStyle = ctx.fillStyle;
                        ctx.fillStyle = game.clearColor;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = origStyle;
                    },
                    drawScreen: function drawScreen(sp) {
                        // Update fps-counter
                        if (++frameCount >= 10) {
                            var now = new Date().getTime();
                            fps = 10000.0 / (now - lastFrame);
                            lastFrame = now;
                            fpsBox.innerHTML = fps;
                            frameCount = 0;
                        }
                    },

                    // Cast operators
                    dbl: function dbl(sp) {
                        var x = MEMS32[(sp - 4) >> 2];
                        MEMF32[(sp - 4) >> 2] = x;
                    },
                    int: function int(sp) {
                        var x = MEMF32[(sp - 4) >> 2];
                        MEMS32[(sp - 4) >> 2] = x;
                    },

                    // Math functions
                    sinInt: function sinInt(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.sin(MEMS32[(sp - 4) >> 2]);
                    },
                    sinDbl: function sinDbl(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.sin(MEMF32[(sp - 4) >> 2]);
                    },
                    cosInt: function cosInt(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.cos(MEMS32[(sp - 4) >> 2]);
                    },
                    cosDbl: function cosDbl(sp) {
                        MEMF32[(sp - 4) >> 2] = Math.cos(MEMF32[(sp - 4) >> 2]);
                    },

                    // Time functions
                    hours: function hours(sp) {
                        MEMS32[sp >> 2] = new Date().getHours();
                    },
                    minutes: function minutes(sp) {
                        MEMS32[sp >> 2] = new Date().getMinutes();
                    },
                    seconds: function seconds(sp) {
                        MEMS32[sp >> 2] = new Date().getSeconds();
                    },
                    milliseconds: function milliseconds(sp) {
                        MEMS32[sp >> 2] = new Date().getMilliseconds();
                    },

                    // Logging functions
                    logInt: function logInt(sp) {
                        console.log(MEMS32[(sp - 4) >> 2]);
                    },
                    logDbl: function logDbl(sp) {
                        console.log(MEMF32[(sp - 4) >> 2]);
                    },

                    // Some compiler-only functions
                    __log: function __log(i) {
                        return;
                        console.log(i);
                        var sp = game.sp() >> 2;
                        var cs = game.cs() >> 2;

                        // Dump memory
                        var dmp = [];
                        var buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(i);
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(MEMS32[i]);
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(i === sp ? '^' : '');
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(MEMS32[256 + i]);
                        dmp.push(buf.join('\t'));

                        buf = [];
                        for (var i = 0; i < 50; i++)
                            buf.push(i === (cs - 256) ? '^' : '');
                        dmp.push(buf.join('\t'));


                        document.getElementById('memdump').innerHTML = dmp.join('\n');
                    }
                },
                heap);

            game.init();
            var running = false;
            var funcBox = document.getElementById('funcBox');
            function step() {
                game.next();
                funcBox.innerHTML = MEMS32[game.cs() >> 2];
            }
            function run() {
                if (!running)
                    return;
                step();
                window.requestAnimationFrame(run);
            }
            function reset() {
                canvas.width = canvas.width;        // Clear the canvas
                stop();
                game.reset();
            }
            function start() {
                running = true;
                run();
            }
            function stop() {
                running = false;
            }
            document.getElementById('startBtn').addEventListener('click', start);
            document.getElementById('stopBtn').addEventListener('click', stop);
            document.getElementById('resetBtn').addEventListener('click', reset);
            document.getElementById('stepBtn').addEventListener('click', step);

            window.ebstart = start;
            window.ebstop = stop;
            window.ebreset = reset;
            window.ebstep = step;
        }
    </script>
</head>
<body>
    <div id="header">
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="resetBtn">Reset</button>
        <button id="stepBtn">Step</button>
        FPS: <span id="fpsBox"></span>
        Function: <span id="funcBox"></span>
        <pre id="memdump"></pre>
    </div>
    <canvas id="canv" width="640" height="480"></canvas>
</body>
</html>
